#!/bin/bash
#
# This script configure the network interace of the VM
#
# You should adapt this file following 

###
# General network information
###

. common/network

# Get the interfaces
get_mac() {
  IFACE=`/sbin/ifconfig -a | grep ^eth0 | sed 's/ *Link encap:Ethernet.*HWaddr /-/g'`
  echo $IFACE | cut -d'-' -f 2
}


# Gets IP address from a given MAC
mac2ip() {
  mac=$1

  let ip_a=0x`echo $mac | cut -d: -f 3`
  let ip_b=0x`echo $mac | cut -d: -f 4`
  let ip_c=0x`echo $mac | cut -d: -f 5`
  let ip_d=0x`echo $mac | cut -d: -f 6`

  ip="$ip_a.$ip_b.$ip_c.$ip_d"

  echo $ip

}



export PATH=/sbin:${PATH}

ENI="/etc/network/interfaces"
DNS="/etc/resolv.conf"
MACADDR=`get_mac`
IPADDR=`mac2ip $MACADDR`
EXTRA=`cat common/routes`
###
# Remove ethernet udev rule.
# Useful for multiple VMs.
###
rm /etc/udev/rules.d/70-persistent-net.rules 
rm /etc/udev/rules.d/70-persistent-cd.rules 

###
# Remove all extra stuff from e/n/i
###
cat > $ENI <<EOF
#This file was generated by contextualization scripts
auto lo
iface lo inet loopback

EOF

cat >> $ENI <<EOF
auto eth0
iface eth0 inet static
    address $IPADDR 
    netmask $NETMASK
    gateway $GATEWAY
    network $NETWORK
    broadcast $BROADCAST

    $EXTRA
EOF

###
# Common part :
# - set dns
# - set hostname
# - restart network
###
cat > $DNS <<EOF
#This file was generated by contextualization scripts
domain $DOMAIN
search $DOMAIN
nameserver $NAMESERVER
EOF

HOSTNAME=vm-$(echo $IPADDR | cut -d '.' -f 1-4)
echo $HOSTNAME > /etc/hostname && hostname $HOSTNAME
/etc/init.d/networking restart

